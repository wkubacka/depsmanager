<!-- Fetch Project -->
<section class="card">
  <h2>Fetch dependencies for a project</h2>

  @if (fetchError) {
    <div class="error" style="margin-bottom:8px;">{{ fetchError }}</div>
  }

  <div class="row">
    <input [formControl]="projectInput" placeholder="Project name (e.g., org/repo)" />
    <select [formControl]="versionCtrl" title="Select version" [disabled]="!versions.length">
      <option value="" disabled selected>-- select version --</option>
      @for (v of versions; track v) {
        <option [value]="v">{{ v }}</option>
      }
    </select>

    <button (click)="onFetchProject()"
            [disabled]="isFetching || !projectInput.value || !versionCtrl.value">
      Fetch
    </button>
  </div>

  @if (versionsError) {
    <div class="error">{{ versionsError }}</div>
  }

  @if (isLoadingVersions) {
    <div class="hint">Loading versions…</div>
  } @else if (projectInput.value && versions.length === 0) {
    <div class="hint">No versions found for this project.</div>
  }

  @if (isFetching) {
    <div class="hint">Fetching…</div>
  }
</section>

<!-- Searchers -->
<section class="card">
  <div class="card-header">
    <h2 class="card-title">Search</h2>
  </div>

  <!-- 1) Projects by dependency -->
  <div class="subcard">
    <h3>Projects by dependency</h3>
    <form (submit)="$event.preventDefault(); searchProjectsByDependency()">
      <input class="input-lg" type="text" [formControl]="depSearchCtrl" placeholder="Dependency name, e.g. lodash" />
      <button type="submit" [disabled]="depSearchLoading">Search</button>
    </form>

    @if (depSearchError) {
      <div class="error">{{ depSearchError }}</div>
    }
    @if (depSearchLoading) {
      <div class="hint">Searching…</div>
    }

    <table *ngIf="!depSearchLoading && projectsByDep?.length">
      <thead>
        <tr>
          <th>Project</th>
          <th>Version</th>
          <th>Updated</th>
        </tr>
      </thead>
      <tbody>
        @for (p of projectsByDep; track (p.name + ':' + p.version)) {
          <tr>
            <td>{{ p.name }}</td>
            <td><code>{{ p.version }}</code></td>
            <td>{{ formatDate(p.updated_at) }}</td>
          </tr>
        }
      </tbody>
    </table>

    <div class="hint" *ngIf="!depSearchLoading && projectsByDep && projectsByDep.length === 0">
      No results.
    </div>
  </div>

  <hr/>

  <!-- 2) Dependencies by score -->
  <div class="subcard">
    <h3>Dependencies by score</h3>
    <form (submit)="$event.preventDefault(); searchDependenciesByScore()">
      <input class="input-lg" type="number" step="0.01" min="-10" max="10" inputmode="decimal" lang="en"
             [formControl]="scoreSearchCtrl" placeholder="Score, e.g. 0.815" />
      <button type="submit" [disabled]="scoreSearchLoading">Search</button>
    </form>

    @if (scoreSearchError) {
      <div class="error">{{ scoreSearchError }}</div>
    }
    @if (scoreSearchLoading) {
      <div class="hint">Searching…</div>
    }

    <ul *ngIf="!scoreSearchLoading && depsByScore?.length">
      <li *ngFor="let n of depsByScore">{{ n }}</li>
    </ul>

    <div class="hint" *ngIf="!scoreSearchLoading && depsByScore && depsByScore.length === 0">
      No results.
    </div>
  </div>
</section>

<!-- Projects -->
<section class="card">
  <div class="card-header">
    <h2 class="card-title">Projects</h2>
    <div class="card-actions">
      <input
        class="search"
        type="text"
        placeholder="Search projects…"
        [value]="search()"
        (input)="search.set(($any($event.target)).value)"
      />
      <button (click)="refreshProjects()" [disabled]="isLoadingProjects">
        {{ isLoadingProjects ? 'Refreshing…' : 'Refresh' }}
      </button>
    </div>
  </div>

  @if (projectsError) {
    <div class="error">Error: {{ projectsError }}</div>
  }

  <div class="projects-wrap">
    <div class="projects-card">
      @if (projects()?.length) {
        <table class="projects-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Version</th>
              <th>Updated</th>
              <th class="actions-col">Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (p of filteredProjects(); track (p.name + ':' + p.version)) {
              <tr>
                <td><strong>{{ p.name }}</strong></td>
                <td><code>{{ p.version }}</code></td>
                <td>{{ formatDate(p.updated_at) }}</td>
                <td class="actions">
                  <button (click)="onListDependenciesFor(p.name, p.version)">List deps</button>
                  <button (click)="updateProject(p.name, p.version)"
                          [disabled]="updatingRow[p.name + '@' + p.version]">
                    {{ updatingRow[p.name + '@' + p.version] ? 'Updating…' : 'Update' }}
                  </button>
                  <button class="danger" (click)="onRemoveProject(p.name, p.version)">Remove</button>
                </td>
              </tr>

              @if (updatingErr[p.name + '@' + p.version]) {
                <tr class="row-error">
                  <td colspan="4" class="error">
                    Update error: {{ updatingErr[p.name + '@' + p.version] }}
                  </td>
                </tr>
              }
            }
          </tbody>
        </table>
      } @else {
        <div class="empty">No projects yet.</div>
      }

      @if (isLoadingProjects) {
        <div class="hint">Loading projects…</div>
      }
    </div>
  </div>
</section>

<!-- Dependencies -->
@if (selectedProjectName && selectedVersion) {
  <section class="card">
    <h2>
      Dependencies for <code>{{ selectedProjectName }}</code> version: <code>{{ selectedVersion }}</code>
    </h2>

    @if (depsError) {
      <div class="error">Error: {{ depsError }}</div>
    } @else {

      <!-- Add dependency toolbar -->
      <div style="margin: 8px 0;">
        @if (!addDepOpen) {
          <button (click)="openAddDependency()">Add dependency</button>
        } @else {
          <div class="row" style="gap:8px; flex-wrap:wrap;">
            <input placeholder="Dependency name" [formControl]="addDepNameCtrl" class="input-lg" />
            <input placeholder="Score (-10..10)" [formControl]="addDepScoreCtrl" class="input-lg"
                   type="number" min="-10" max="10" step="0.01" inputmode="decimal" lang="en"/>
            <button (click)="submitAddDependency()" [disabled]="addDepLoading">Save</button>
            <button (click)="cancelAddDependency()" type="button">Cancel</button>
          </div>
          @if (addDepError) { <div class="error">{{ addDepError }}</div> }
          @if (addDepLoading) { <div class="hint">Saving…</div> }
        }
      </div>

      <div class="deps">
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>OpenSSF score</th>
              <th>Updated</th>
              <th class="actions-col">Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (d of filteredDependencies(); track d.name) {
              <tr>
                <td>{{ d.name }}</td>

                <!-- Score cell: either editing or static -->
                <td>
                  @if (editingDepName === d.name) {
                    <input [formControl]="editScoreCtrl" type="number" min="-10" max="10" step="0.01"
                           inputmode="decimal" lang="en" style="width:120px;" />
                  } @else {
                    {{ d.score }}
                  }
                </td>

                <td>{{ formatDate(d.updated_at) }}</td>

                <td class="actions">
                  @if (editingDepName === d.name) {
                    <button (click)="submitEditDependency(d.name)" [disabled]="editDepLoading">Save</button>
                    <button (click)="cancelEditDependency()" type="button">Cancel</button>
                  } @else {
                    <button (click)="startEditDependency(d)">Edit</button>
                    <button class="danger"
                            (click)="deleteDependency(d.name)"
                            [disabled]="deletingDep[d.name]">
                      {{ deletingDep[d.name] ? 'Deleting…' : 'Delete' }}
                    </button>
                  }
                </td>
              </tr>

              @if (editingDepName === d.name && editDepError) {
                <tr class="row-error">
                  <td colspan="4" class="error">Edit error: {{ editDepError }}</td>
                </tr>
              }

              @if (deleteDepError[d.name]) {
                <tr class="row-error">
                  <td colspan="4" class="error">Delete error: {{ deleteDepError[d.name] }}</td>
                </tr>
              }
            }
          </tbody>
        </table>

        @if (!dependencies?.length && !isLoadingDeps) {
          <div class="hint">No dependencies.</div>
        }
        @if (isLoadingDeps) {
          <div class="hint">Loading dependencies…</div>
        }
      </div>

      @if (dependencies?.length) {
        <div class="chart-wrapper">
          <canvas baseChart
                  [data]="barChartData"
                  [options]="barChartOptions"
                  [type]="'bar'">
          </canvas>
        </div>
      }
    }
  </section>
}
